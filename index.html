<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007bff;
            --light-color: #f8f9fa;
            --body-bg: #f0f2f5;
            --danger-color: #dc3545;
            --success-color: #28a745;
            --warning-color: #ffc107; /* Also used for edit buttons */
            --edit-color: var(--warning-color);
        }
        html { font-size: 16px; }
        body {
            font-family: 'Cairo', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--body-bg);
            padding-bottom: 70px;
            direction: rtl;
            line-height: 1.6;
        }
        header {
            background-color: var(--primary-color);
            color: #fff;
            padding: 1rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .site-name { margin: 0; font-size: 1.5rem; }
        main { padding: 1rem; }

        .admin-page {
            display: none;
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .admin-page.active { display: block; }
        .admin-page h2 {
            color: #333;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.75rem;
            margin-top: 0;
            margin-bottom: 1.25rem;
            font-size: 1.4rem;
        }
        .admin-page h2 i { margin-left: 0.5rem; }

        .form-group { margin-bottom: 1rem; }
        .form-group label {
            display: block;
            margin-bottom: 0.4rem;
            font-weight: 700;
            font-size: 0.9rem;
        }
        .form-group input[type="text"],
        .form-group input[type="url"],
        .form-group input[type="number"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 0.9rem;
        }
        .form-group textarea { min-height: 100px; resize: vertical; }

        button.submit-btn, button.delete-btn, button.edit-btn {
            color: #fff;
            padding: 0.7rem 1.2rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s ease;
            margin-right: 5px;
        }
        button.submit-btn { background-color: var(--primary-color); }
        button.submit-btn:hover { background-color: #0056b3; }

        button.delete-btn {
            background-color: var(--danger-color);
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }
        button.delete-btn:hover { background-color: #c82333; }

        button.edit-btn {
            background-color: var(--edit-color);
            color: #212529;
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }
        button.edit-btn:hover { background-color: #e0a800; }

        button.submit-btn i, button.delete-btn i, button.edit-btn i { margin-left: 0.3rem; }


        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #fff;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            padding: 0.3rem 0;
            z-index: 100;
        }
        .nav-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #555;
            padding: 0.3rem;
            flex-grow: 1;
            text-align: center;
        }
        .nav-link i { font-size: 1.25rem; }
        .nav-link span { font-size: 0.75rem; }
        .nav-link.active {
            color: var(--primary-color);
            font-weight: 700;
        }

        .table-responsive-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 1.25rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #fff;
            min-width: 700px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 0.75rem;
            text-align: right;
            font-size: 0.9rem;
            vertical-align: middle;
        }
        th {
            background-color: var(--light-color);
            font-weight: 700;
        }

        /* Categories Admin Styles */
        .categories-admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1rem;
            margin-top: 20px;
        }
        .category-admin-card {
            background-color: var(--light-color);
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
        .category-admin-card img {
            max-width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 0.75rem;
        }
        .category-admin-card .category-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }
        .category-admin-card .actions-container {
            margin-top: auto;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }

        /* Products List for Admin */
        #manage-products-page .products-list-item {
            background-color: var(--light-color);
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        #manage-products-page .products-list-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 5px;
        }
        #manage-products-page .products-list-item .product-info {
            flex-grow: 1;
        }
        #manage-products-page .products-list-item .product-info h3 {
            margin-top: 0;
            margin-bottom: 0.3rem;
            font-size: 1.1rem;
        }
        #manage-products-page .products-list-item .product-info p {
            font-size: 0.85rem;
            color: #555;
            margin-bottom: 0.2rem;
            word-break: break-word; /* Prevent long descriptions from breaking layout */
        }
        #manage-products-page .products-list-item .actions-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-end;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
        }
        .modal-content-wrapper { /* New wrapper for centering */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100%;
            padding: 20px; /* Padding for scrollable content */
            box-sizing: border-box;
        }
        .modal-content {
            background-color: #fefefe;
            /* margin: 5% auto; Removed for wrapper centering */
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-height: 90vh; /* Max height for scrollability */
            overflow-y: auto; /* Enable scroll for content */
        }
        .modal-content h3 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            text-align: center;
        }
        .close-modal-btn {
            color: #aaa;
            position: absolute;
            left: 15px;
            top: 10px;
            font-size: 28px;
            font-weight: bold;
            line-height: 1;
        }
        .close-modal-btn:hover,
        .close-modal-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .order-details-toggle {
            cursor: pointer;
            color: var(--primary-color);
            text-decoration: underline;
        }
        .nested-details {
            padding: 10px;
            margin-top: 5px;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 4px;
            font-size: 0.85em;
        }


        @media (max-width: 768px) {
            html { font-size: 15px; }
            main { padding: 0.75rem; }
            .admin-page { padding: 1rem; }
            table { min-width: 0; }
            th, td { padding: 0.5rem; font-size: 0.85rem; }
             .modal-content { width: 95%; margin-top: 5vh; margin-bottom: 5vh;}
        }
        @media (max-width: 576px) {
            html { font-size: 14px; }
            .site-name { font-size: 1.3rem; }
            .admin-page h2 { font-size: 1.2rem; }
            button.submit-btn, button.delete-btn, button.edit-btn { font-size: 0.9rem; padding: 0.6rem 1rem; }
            .nav-link i { font-size: 1.1rem; }
            .nav-link span { font-size: 0.7rem; }
            table thead { display: none; }
            table tr { display: block; margin-bottom: 1rem; border: 1px solid #ddd; }
            table td { display: block; text-align: right; border-bottom: 1px dotted #eee; }
            table td::before { content: attr(data-label); float: right; font-weight: 700; margin-left: 10px; }
            .status-select { width: 100%; margin-top: 5px; } /* Ensure select takes full width on small screens */
            #manage-products-page .products-list-item { flex-direction: column; align-items: stretch; }
            #manage-products-page .products-list-item .actions-container {
                flex-direction: row;
                justify-content: space-around;
                margin-top: 0.5rem;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1 class="site-name">Hassan Elhoot</h1>
    </header>

    <main>
        <section id="upload-product-page" class="admin-page active">
            <h2><i class="fas fa-upload"></i> رفع منتج جديد</h2>
            <form id="upload-product-form">
                <div class="form-group"><label for="product-title">عنوان المنتج:</label><input type="text" id="product-title" required></div>
                <div class="form-group"><label for="product-description">وصف المنتج:</label><textarea id="product-description" required></textarea></div>
                <div class="form-group"><label for="product-image-url1">رابط الصورة 1 (رئيسية):</label><input type="url" id="product-image-url1" required></div>
                <div class="form-group"><label for="product-image-url2">رابط الصورة 2 (اختياري):</label><input type="url" id="product-image-url2"></div>
                <div class="form-group"><label for="product-image-url3">رابط الصورة 3 (اختياري):</label><input type="url" id="product-image-url3"></div>
                <div class="form-group"><label for="product-price">السعر (اختياري):</label><input type="number" id="product-price" step="0.01" min="0"></div>
                <div class="form-group">
                    <label for="product-category">اختر الفئة:</label>
                    <select id="product-category" required>
                        <option value="">-- اختر فئة --</option>
                    </select>
                </div>
                <button type="submit" class="submit-btn"><i class="fas fa-plus-circle"></i> إضافة المنتج</button>
            </form>
        </section>

        <section id="manage-products-page" class="admin-page">
            <h2><i class="fas fa-box-open"></i> إدارة المنتجات</h2>
            <div id="products-admin-display-area">
                <p>جاري تحميل المنتجات...</p>
            </div>
        </section>

        <section id="manage-categories-page" class="admin-page">
            <h2><i class="fas fa-tags"></i> إدارة الفئات</h2>
            <form id="add-category-form">
                <div class="form-group"><label for="category-name-input">اسم الفئة الجديدة:</label><input type="text" id="category-name-input" required></div>
                <div class="form-group"><label for="category-image-url">رابط صورة الفئة:</label><input type="url" id="category-image-url" required></div>
                <button type="submit" class="submit-btn"><i class="fas fa-plus"></i> إضافة فئة</button>
            </form>
            <div id="categories-admin-display-area" class="categories-admin-grid" style="margin-top:20px;">
                <p>جاري تحميل الفئات...</p>
            </div>
        </section>

        <section id="view-users-page" class="admin-page">
            <h2><i class="fas fa-users"></i> المستخدمون</h2>
            <div class="table-responsive-wrapper">
                <div id="users-table-container"><p>جاري تحميل المستخدمين...</p></div>
            </div>
        </section>

        <section id="view-orders-page" class="admin-page">
            <h2><i class="fas fa-shopping-cart"></i> الطلبات</h2>
            <div class="table-responsive-wrapper">
                <div id="orders-table-container"><p>جاري تحميل الطلبات...</p></div>
            </div>
        </section>
    </main>

    <footer>
        <nav class="bottom-nav">
            <a href="#upload-product-page" class="nav-link active" data-page="upload-product-page"><i class="fas fa-upload"></i><span>رفع منتج</span></a>
            <a href="#manage-products-page" class="nav-link" data-page="manage-products-page"><i class="fas fa-box-open"></i><span>المنتجات</span></a>
            <a href="#manage-categories-page" class="nav-link" data-page="manage-categories-page"><i class="fas fa-tags"></i><span>الفئات</span></a>
            <a href="#view-users-page" class="nav-link" data-page="view-users-page"><i class="fas fa-users"></i><span>المستخدمون</span></a>
            <a href="#view-orders-page" class="nav-link" data-page="view-orders-page"><i class="fas fa-shopping-cart"></i><span>الطلبات</span></a>
        </nav>
    </footer>

    <!-- Edit Product Modal -->
    <div id="edit-product-modal" class="modal">
        <div class="modal-content-wrapper">
            <div class="modal-content">
                <span class="close-modal-btn" data-modal-id="edit-product-modal">×</span>
                <h3>تعديل المنتج</h3>
                <form id="edit-product-form">
                    <input type="hidden" id="edit-product-id">
                    <div class="form-group"><label for="edit-product-title">عنوان المنتج:</label><input type="text" id="edit-product-title" required></div>
                    <div class="form-group"><label for="edit-product-description">وصف المنتج:</label><textarea id="edit-product-description" required></textarea></div>
                    <div class="form-group"><label for="edit-product-image-url1">رابط الصورة 1:</label><input type="url" id="edit-product-image-url1" required></div>
                    <div class="form-group"><label for="edit-product-image-url2">رابط الصورة 2:</label><input type="url" id="edit-product-image-url2"></div>
                    <div class="form-group"><label for="edit-product-image-url3">رابط الصورة 3:</label><input type="url" id="edit-product-image-url3"></div>
                    <div class="form-group"><label for="edit-product-price">السعر:</label><input type="number" id="edit-product-price" step="0.01" min="0"></div>
                    <div class="form-group">
                        <label for="edit-product-category">الفئة:</label>
                        <select id="edit-product-category" required></select>
                    </div>
                    <button type="submit" class="submit-btn"><i class="fas fa-save"></i> حفظ التعديلات</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div id="edit-category-modal" class="modal">
         <div class="modal-content-wrapper">
            <div class="modal-content">
                <span class="close-modal-btn" data-modal-id="edit-category-modal">×</span>
                <h3>تعديل الفئة</h3>
                <form id="edit-category-form">
                    <input type="hidden" id="edit-category-id">
                    <div class="form-group"><label for="edit-category-name">اسم الفئة:</label><input type="text" id="edit-category-name" required></div>
                    <div class="form-group"><label for="edit-category-image-url">رابط صورة الفئة:</label><input type="url" id="edit-category-image-url" required></div>
                    <button type="submit" class="submit-btn"><i class="fas fa-save"></i> حفظ التعديلات</button>
                </form>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, getDoc, serverTimestamp, orderBy, query, updateDoc, onSnapshot, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjE-2q6PONBkCin9ZN22gDp9Q8pAH9ZW8",
            authDomain: "story-97cf7.firebaseapp.com",
            projectId: "story-97cf7",
            storageBucket: "story-97cf7.appspot.com",
            messagingSenderId: "742801388214",
            appId: "1:742801388214:web:32a305a8057b0582c5ec17",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const adminNavLinks = document.querySelectorAll('footer .nav-link');
        const adminPages = document.querySelectorAll('.admin-page');
        const productCategorySelect = document.getElementById('product-category');
        const editProductCategorySelect = document.getElementById('edit-product-category');

        const editProductModalEl = document.getElementById('edit-product-modal');
        const editCategoryModalEl = document.getElementById('edit-category-modal');

        let currentUnsubscribe = {};

        function setActivePage(pageId) {
            Object.keys(currentUnsubscribe).forEach(key => {
                if (key !== pageId && currentUnsubscribe[key]) {
                    console.log(`Unsubscribing from ${key}`);
                    currentUnsubscribe[key]();
                    currentUnsubscribe[key] = null;
                }
            });

            adminPages.forEach(p => p.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) targetPage.classList.add('active');

            if (pageId === 'view-users-page' && !currentUnsubscribe[pageId]) {
                subscribeToData('users', document.getElementById('users-table-container'), renderUsersTable, pageId, orderBy("createdAt", "desc"));
            } else if (pageId === 'view-orders-page' && !currentUnsubscribe[pageId]) {
                subscribeToData('orders', document.getElementById('orders-table-container'), renderOrdersTable, pageId, orderBy("orderDate", "desc"));
            } else if (pageId === 'manage-categories-page' && !currentUnsubscribe[pageId]) {
                subscribeToData('categories', document.getElementById('categories-admin-display-area'), renderCategoriesAdmin, pageId, orderBy("name", "asc"));
            } else if (pageId === 'manage-products-page' && !currentUnsubscribe[pageId]) {
                subscribeToData('products', document.getElementById('products-admin-display-area'), renderProductsAdmin, pageId, orderBy("createdAt", "desc"));
            } else if (pageId === 'upload-product-page') {
                loadCategoriesForProductForm();
            }
        }

        adminNavLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                adminNavLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                setActivePage(link.getAttribute('data-page'));
            });
        });

        async function loadCategoriesForProductForm(selectElement = productCategorySelect, selectedCategoryId = null) {
            if (!selectElement) {
                console.warn("Category select element not found for loading categories.");
                return;
            }
            try {
                const categoriesCol = collection(db, 'categories');
                const q = query(categoriesCol, orderBy("name", "asc"));
                const snapshot = await getDocs(q);

                selectElement.innerHTML = '<option value="">-- اختر فئة --</option>';
                if (snapshot.empty) {
                    const option = document.createElement('option');
                    option.textContent = "لا توجد فئات مضافة بعد";
                    option.disabled = true;
                    selectElement.appendChild(option);
                } else {
                    snapshot.forEach(docSnap => {
                        const category = docSnap.data();
                        const option = document.createElement('option');
                        option.value = docSnap.id;
                        option.textContent = category.name || 'فئة بدون اسم';
                        if (selectedCategoryId === docSnap.id) {
                            option.selected = true;
                        }
                        selectElement.appendChild(option);
                    });
                }
            } catch (error) {
                console.error("Error loading categories for form: ", error);
                selectElement.innerHTML = '<option value="">خطأ في تحميل الفئات</option>';
            }
        }

        document.getElementById('upload-product-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const titleEl = document.getElementById('product-title');
            const descriptionEl = document.getElementById('product-description');
            const imageUrl1El = document.getElementById('product-image-url1');
            const priceEl = document.getElementById('product-price');

            const title = titleEl.value.trim();
            const description = descriptionEl.value.trim();
            const imageUrl1 = imageUrl1El.value.trim();
            const priceValue = priceEl.value;
            const categoryId = productCategorySelect.value;

            if (!title || !description || !imageUrl1) {
                alert('الرجاء ملء حقول العنوان والوصف ورابط الصورة الرئيسية.');
                return;
            }
            if (!categoryId) {
                alert('الرجاء اختيار فئة للمنتج.');
                return;
            }

            const imageUrls = [
                imageUrl1,
                document.getElementById('product-image-url2').value.trim(),
                document.getElementById('product-image-url3').value.trim()
            ].filter(Boolean);

            try {
                const docRef = await addDoc(collection(db, 'products'), {
                    title,
                    description,
                    imageUrls,
                    price: priceValue ? parseFloat(priceValue) : null,
                    categoryId,
                    createdAt: serverTimestamp()
                });
                console.log("Product added with ID: ", docRef.id);
                alert('تم رفع المنتج بنجاح!');
                e.target.reset();
                productCategorySelect.value = "";
            } catch (err) {
                console.error("Error uploading product:", err);
                alert('حدث خطأ أثناء رفع المنتج.');
            }
        });

        document.getElementById('add-category-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nameInput = document.getElementById('category-name-input');
            const imageUrlInput = document.getElementById('category-image-url');
            const name = nameInput.value.trim();
            const imageUrl = imageUrlInput.value.trim();

            if (!name || !imageUrl) {
                alert('الرجاء إدخال اسم الفئة ورابط الصورة.');
                return;
            }

            try {
                const docRef = await addDoc(collection(db, 'categories'), {
                    name,
                    imageUrl,
                    createdAt: serverTimestamp()
                });
                console.log("Category added with ID: ", docRef.id);
                alert(`تمت إضافة الفئة: ${name} بنجاح!`);
                e.target.reset();
            } catch (err) {
                console.error("Error adding category:", err);
                alert('حدث خطأ أثناء إضافة الفئة.');
            }
        });

        function subscribeToData(collectionName, containerElement, renderFunction, pageKey, ...queryConstraints) {
            if (!containerElement) {
                console.error(`Container element for ${collectionName} not found.`);
                return;
            }
            containerElement.innerHTML = '<p>جاري التحميل...</p>';

            const effectiveQueryConstraints = queryConstraints.length > 0 ? queryConstraints : [];
            const dataQuery = query(collection(db, collectionName), ...effectiveQueryConstraints);

            currentUnsubscribe[pageKey] = onSnapshot(dataQuery, (snapshot) => {
                if (snapshot.empty) {
                    let sectionName = '';
                    if (collectionName === 'users') sectionName = 'المستخدمين';
                    else if (collectionName === 'orders') sectionName = 'الطلبات';
                    else if (collectionName === 'categories') sectionName = 'الفئات';
                    else if (collectionName === 'products') sectionName = 'المنتجات';
                    else sectionName = collectionName;
                    containerElement.innerHTML = `<p>لا توجد بيانات حالياً في قسم ${sectionName}.</p>`;
                    return;
                }
                renderFunction(snapshot, containerElement);
            }, (error) => {
                console.error(`Error loading ${collectionName}: `, error);
                let errorMessage = '<p>حدث خطأ أثناء تحميل البيانات. يرجى المحاولة مرة أخرى أو مراجعة وحدة التحكم.</p>';
                if (error.code === 'failed-precondition' && error.message.includes('index')) {
                     let collectionDisplayName = '';
                     if (collectionName === 'orders') collectionDisplayName = 'الطلبات';
                     else if (collectionName === 'products') collectionDisplayName = 'المنتجات';
                     else if (collectionName === 'categories') collectionDisplayName = 'الفئات';
                     else if (collectionName === 'users') collectionDisplayName = 'المستخدمين';
                     else collectionDisplayName = collectionName;

                     errorMessage = `<p style="color:red; font-weight:bold;">خطأ في الفهرس للوصول إلى بيانات "${collectionDisplayName}".</p>
                                     <p>عادةً، هذا يعني أن Firestore يتطلب فهرسًا مركبًا لم يتم إنشاؤه بعد. </p>
                                     <p>يرجى فتح وحدة تحكم المتصفح (Browser Console) للبحث عن رسالة خطأ تحتوي على رابط مباشر لإنشاء هذا الفهرس في لوحة تحكم Firebase.</p>
                                     <p>رسالة الخطأ الأصلية: ${error.message}</p>`;
                }
                containerElement.innerHTML = errorMessage;
            });
        }

        function renderUsersTable(snapshot, container) {
            let html = '<table><thead><tr><th>الاسم</th><th>الهاتف</th><th>المحافظة</th><th>المدينة</th><th>تفاصيل العنوان</th><th>تاريخ التسجيل</th></tr></thead><tbody>';
            snapshot.forEach(doc => {
                const u = doc.data();
                const registrationDate = u.createdAt?.toDate() ? u.createdAt.toDate().toLocaleDateString('ar-EG', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 'غير محدد';
                html += `<tr>
                            <td data-label="الاسم:">${u.name || 'غير متوفر'}</td>
                            <td data-label="الهاتف:">${u.phone || 'غير متوفر'}</td>
                            <td data-label="المحافظة:">${u.governorate || 'غير محددة'}</td>
                            <td data-label="المدينة:">${u.city || 'غير محددة'}</td>
                            <td data-label="تفاصيل العنوان:">${u.details || '-'}</td>
                            <td data-label="تاريخ التسجيل:">${registrationDate}</td>
                         </tr>`;
            });
            container.innerHTML = html + '</tbody></table>';
        }

        function renderCategoriesAdmin(snapshot, container) {
            let html = '';
            if (snapshot.empty) { container.innerHTML = '<p>لم يتم إضافة أي فئات بعد.</p>'; return; }
            snapshot.forEach(docSnap => {
                const category = docSnap.data();
                const categoryId = docSnap.id;
                const imageUrl = category.imageUrl || 'https://via.placeholder.com/200x150?text=فئة';
                html += `
                    <div class="category-admin-card">
                        <img src="${imageUrl}" alt="${category.name || 'فئة'}">
                        <p class="category-name">${category.name || 'فئة بدون اسم'}</p>
                        <div class="actions-container">
                            <button class="edit-btn edit-category-btn" data-id="${categoryId}"><i class="fas fa-edit"></i> تعديل</button>
                            <button class="delete-btn delete-category-btn" data-id="${categoryId}"><i class="fas fa-trash-alt"></i> مسح</button>
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
            attachDeleteListeners('.delete-category-btn', 'categories', 'الفئة');
            attachEditCategoryListeners();
        }

        function renderProductsAdmin(snapshot, container) {
            let html = '';
            if (snapshot.empty) { container.innerHTML = '<p>لم يتم إضافة أي منتجات بعد.</p>'; return; }
            snapshot.forEach(docSnap => {
                const product = docSnap.data();
                const productId = docSnap.id;
                const mainImageUrl = (Array.isArray(product.imageUrls) && product.imageUrls.length > 0)
                                    ? product.imageUrls[0]
                                    : 'https://via.placeholder.com/80?text=منتج';
                const priceDisplay = product.price ? `${product.price} ج.م` : 'غير محدد';

                html += `
                    <div class="products-list-item">
                        <img src="${mainImageUrl}" alt="${product.title || 'منتج'}">
                        <div class="product-info">
                            <h3>${product.title || 'منتج بدون عنوان'}</h3>
                            <p><strong>السعر:</strong> ${priceDisplay}</p>
                            <p><strong>الوصف:</strong> ${ (product.description && product.description.length > 50) ? product.description.substring(0, 50) + '...' : (product.description || '-') }</p>
                        </div>
                        <div class="actions-container">
                             <button class="edit-btn edit-product-btn" data-id="${productId}"><i class="fas fa-edit"></i> تعديل</button>
                             <button class="delete-btn delete-product-btn" data-id="${productId}"><i class="fas fa-trash-alt"></i> مسح</button>
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
            attachDeleteListeners('.delete-product-btn', 'products', 'المنتج');
            attachEditProductListeners();
        }

        function renderOrdersTable(snapshot, container) {
            let html = '<table><thead><tr><th>رقم الطلب</th><th>صورة المنتج</th><th>اسم المنتج</th><th>الكمية</th><th>الحالة</th><th>تاريخ الطلب</th><th>تفاصيل العميل</th></tr></thead><tbody>';
            snapshot.forEach(docSnap => {
                const o = docSnap.data();
                const id = docSnap.id;
                const orderDate = o.orderDate?.toDate() ? o.orderDate.toDate().toLocaleString('ar-EG',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit', hour12: true}) : 'غير محدد';

                html += `
                    <tr>
                        <td data-label="رقم الطلب:">${id.substring(0,8)}...</td>
                        <td data-label="صورة المنتج:"><img src="${o.productImageUrl || 'https://via.placeholder.com/40x40?text=N/A'}" alt="${o.productTitle || 'منتج'}" style="width:40px;height:40px;object-fit:cover;border-radius:3px;"></td>
                        <td data-label="اسم المنتج:">${o.productTitle || 'غير متوفر'}</td>
                        <td data-label="الكمية:">${o.quantity || '1'}</td>
                        <td data-label="الحالة:">
                            <select class="status-select" data-order-id="${id}" aria-label="تغيير حالة الطلب">
                                <option value="قيد المراجعة" ${o.status === 'قيد المراجعة' ? 'selected' : ''}>قيد المراجعة</option>
                                <option value="تم الموافقة" ${o.status === 'تم الموافقة' ? 'selected' : ''}>تم الموافقة</option>
                                <option value="تم الرفض" ${o.status === 'تم الرفض' ? 'selected' : ''}>تم الرفض</option>
                                <option value="تم الشحن" ${o.status === 'تم الشحن' ? 'selected' : ''}>تم الشحن</option>
                                <option value="تم التسليم" ${o.status === 'تم التسليم' ? 'selected' : ''}>تم التسليم</option>
                                <option value="ملغى من قبل المستخدم" ${o.status === 'ملغى من قبل المستخدم' ? 'selected' : ''} disabled>ملغى من المستخدم</option>
                                <option value="ملغى من الإدارة" ${o.status === 'ملغى من الإدارة' ? 'selected' : ''}>ملغى من الإدارة</option>
                            </select>
                        </td>
                        <td data-label="تاريخ الطلب:">${orderDate}</td>
                        <td data-label="تفاصيل العميل:">
                            <span class="order-details-toggle" data-order-id="${id}" role="button" tabindex="0">عرض التفاصيل</span>
                            <div class="nested-details" id="details-${id}" style="display: none;">
                                <strong>الاسم:</strong> ${o.customerDetails?.name || 'غير متوفر'}<br>
                                <strong>الهاتف:</strong> ${o.customerDetails?.phone || 'غير متوفر'}<br>
                                <strong>المحافظة:</strong> ${o.customerDetails?.governorate || 'غير محددة'}<br>
                                <strong>المدينة:</strong> ${o.customerDetails?.city || 'غير محددة'}<br>
                                <strong>تفاصيل العنوان:</strong> ${o.customerDetails?.details || '-'}
                            </div>
                        </td>
                    </tr>`;
            });
            container.innerHTML = html + '</tbody></table>';

            container.querySelectorAll('.order-details-toggle').forEach(el => {
                const newEl = el.cloneNode(true);
                el.parentNode.replaceChild(newEl, el); // Replace original with clone to ensure single listener attachment
                const orderId = newEl.dataset.orderId;

                const toggleAction = function() {
                    const detailsDiv = document.getElementById(`details-${orderId}`); // Find globally or scope to table container
                    if (detailsDiv) {
                        if (detailsDiv.style.display === 'none' || detailsDiv.style.display === '') {
                            detailsDiv.style.display = 'block';
                            newEl.textContent = 'إخفاء التفاصيل';
                        } else {
                            detailsDiv.style.display = 'none';
                            newEl.textContent = 'عرض التفاصيل';
                        }
                    } else {
                        console.warn(`Details div with ID 'details-${orderId}' not found.`);
                    }
                };

                newEl.addEventListener('click', toggleAction);
                newEl.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        toggleAction();
                    }
                });
            });

            container.querySelectorAll('.status-select').forEach(el => {
                const newEl = el.cloneNode(true);
                el.parentNode.replaceChild(newEl, el); // Replace original with clone

                newEl.addEventListener('change', async function() {
                    const orderId = this.dataset.orderId;
                    const newStatus = this.value;
                    let originalStatusValue;

                    try {
                        const orderDoc = await getDoc(doc(db, 'orders', orderId));
                        if (orderDoc.exists()) {
                            originalStatusValue = orderDoc.data().status;
                        } else {
                            console.error(`Order doc ${orderId} not found for status revert.`);
                            alert('خطأ: الطلب غير موجود.');
                            return;
                        }
                    } catch (fetchError) {
                        console.error("Error fetching original status:", fetchError);
                        alert('خطأ في جلب الحالة الأصلية للطلب.');
                        return;
                    }

                    try {
                        await updateDoc(doc(db, 'orders', orderId), { status: newStatus });
                        // console.log(`Order ${orderId} status updated to ${newStatus}`);
                    } catch (err) {
                        console.error("Error updating order status:", err);
                        alert('حدث خطأ أثناء تحديث حالة الطلب. سيتم استرجاع الحالة السابقة.');
                        this.value = originalStatusValue; // Revert select value in UI
                    }
                });
            });
        }


        function attachDeleteListeners(selector, collectionName, itemNameSingular) {
            document.querySelectorAll(selector).forEach(button => {
                const newButton = button.cloneNode(true); // Clone to remove old listeners
                button.parentNode.replaceChild(newButton, button);
                newButton.addEventListener('click', async function() {
                    const itemId = this.dataset.id;
                    if (confirm(`هل أنت متأكد من مسح هذا الـ${itemNameSingular} (ID: ${itemId.substring(0,6)}...)?`)) {
                        try {
                            await deleteDoc(doc(db, collectionName, itemId));
                            alert(`تم مسح الـ${itemNameSingular} بنجاح.`);
                        } catch (err) {
                            console.error(`Error deleting ${itemNameSingular}:`, err);
                            alert(`حدث خطأ أثناء مسح الـ${itemNameSingular}.`);
                        }
                    }
                });
            });
        }

        // --- MODAL HANDLING ---
        document.querySelectorAll('.close-modal-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const modalId = this.dataset.modalId;
                if (modalId && document.getElementById(modalId)) {
                     document.getElementById(modalId).style.display = 'none';
                }
            });
        });

        window.addEventListener('click', (event) => { // Changed from onclick to addEventListener
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        });

        // --- EDIT CATEGORY ---
        function attachEditCategoryListeners() {
            document.querySelectorAll('.edit-category-btn').forEach(button => {
                 const newButton = button.cloneNode(true); // Clone to remove old listeners
                 button.parentNode.replaceChild(newButton, button);
                 newButton.addEventListener('click', async function() {
                    const categoryId = this.dataset.id;
                    if (!editCategoryModalEl) { console.error("Edit category modal not found"); return; }
                    try {
                        const categoryDocRef = doc(db, 'categories', categoryId);
                        const categoryDocSnap = await getDoc(categoryDocRef);
                        if (categoryDocSnap.exists()) {
                            const data = categoryDocSnap.data();
                            document.getElementById('edit-category-id').value = categoryId;
                            document.getElementById('edit-category-name').value = data.name || '';
                            document.getElementById('edit-category-image-url').value = data.imageUrl || '';
                            editCategoryModalEl.style.display = 'block';
                        } else {
                            alert('الفئة غير موجودة.');
                        }
                    } catch (err) {
                        console.error("Error fetching category for edit:", err);
                        alert('خطأ في جلب بيانات الفئة للتعديل.');
                    }
                });
            });
        }

        document.getElementById('edit-category-form')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            const categoryId = document.getElementById('edit-category-id').value;
            const name = document.getElementById('edit-category-name').value.trim();
            const imageUrl = document.getElementById('edit-category-image-url').value.trim();

            if (!categoryId) { alert('خطأ: لم يتم تحديد الفئة.'); return; }
            if (!name || !imageUrl) {
                alert('الرجاء ملء جميع حقول تعديل الفئة.');
                return;
            }
            try {
                await updateDoc(doc(db, 'categories', categoryId), { name, imageUrl });
                alert('تم تحديث الفئة بنجاح!');
                if (editCategoryModalEl) editCategoryModalEl.style.display = 'none';
            } catch (err) {
                console.error("Error updating category:", err);
                alert('حدث خطأ أثناء تحديث الفئة.');
            }
        });

        // --- EDIT PRODUCT ---
        function attachEditProductListeners() {
            document.querySelectorAll('.edit-product-btn').forEach(button => {
                 const newButton = button.cloneNode(true); // Clone to remove old listeners
                 button.parentNode.replaceChild(newButton, button);
                 newButton.addEventListener('click', async function() {
                    const productId = this.dataset.id;
                    if (!editProductModalEl) { console.error("Edit product modal not found"); return; }

                    try {
                        const productDocRef = doc(db, 'products', productId);
                        const productDocSnap = await getDoc(productDocRef);
                        if (productDocSnap.exists()) {
                            const data = productDocSnap.data();
                            document.getElementById('edit-product-id').value = productId;
                            document.getElementById('edit-product-title').value = data.title || '';
                            document.getElementById('edit-product-description').value = data.description || '';
                            document.getElementById('edit-product-image-url1').value = data.imageUrls?.[0] || '';
                            document.getElementById('edit-product-image-url2').value = data.imageUrls?.[1] || '';
                            document.getElementById('edit-product-image-url3').value = data.imageUrls?.[2] || '';
                            document.getElementById('edit-product-price').value = data.price || '';

                            if (editProductCategorySelect) { // Ensure the select element exists
                                await loadCategoriesForProductForm(editProductCategorySelect, data.categoryId);
                            } else {
                                console.error("Edit product category select element not found.");
                            }
                            editProductModalEl.style.display = 'block';
                        } else {
                            alert('المنتج غير موجود.');
                        }
                    } catch (err) {
                        console.error("Error fetching product for edit:", err);
                        alert('خطأ في جلب بيانات المنتج للتعديل.');
                    }
                });
            });
        }

        document.getElementById('edit-product-form')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            const productId = document.getElementById('edit-product-id').value;
            const title = document.getElementById('edit-product-title').value.trim();
            const description = document.getElementById('edit-product-description').value.trim();
            const imageUrl1 = document.getElementById('edit-product-image-url1').value.trim();
            const priceValue = document.getElementById('edit-product-price').value;
            const categoryId = editProductCategorySelect ? editProductCategorySelect.value : null;

            if (!productId) { alert('خطأ: لم يتم تحديد المنتج.'); return; }
            if (!title || !description || !imageUrl1 || !categoryId) {
                alert('الرجاء ملء حقول العنوان، الوصف، الصورة الرئيسية، واختيار الفئة.');
                return;
            }
            const imageUrls = [imageUrl1, document.getElementById('edit-product-image-url2').value.trim(), document.getElementById('edit-product-image-url3').value.trim()].filter(Boolean);

            try {
                await updateDoc(doc(db, 'products', productId), {
                    title, description, imageUrls,
                    price: priceValue ? parseFloat(priceValue) : null,
                    categoryId
                });
                alert('تم تحديث المنتج بنجاح!');
                 if (editProductModalEl) editProductModalEl.style.display = 'none';
            } catch (err) {
                console.error("Error updating product:", err);
                alert('حدث خطأ أثناء تحديث المنتج.');
            }
        });

        window.onload = () => {
            const activeLink = document.querySelector('footer .nav-link.active');
            setActivePage(activeLink ? activeLink.getAttribute('data-page') : 'upload-product-page');
        };
    </script>
</body>
</html>
